(()=>{"use strict";const e=["#","＃"];function t(e){return e.normalize("NFKC").toLowerCase().replace(/[ぁ-ん]/g,(e=>String.fromCharCode(e.charCodeAt(0)+96)))}function n(e){return e.replace(/^https?:\/\/(www\.)?/i,"").replace(/\/(index\.html)?$/,"").replace(/^.+?(\/|$)/,(e=>e.toLowerCase()))}function r(n){return t(n.replace(new RegExp(`^[${e.join()}]`),""))}function o(e){return t(e.replace(/^[@＠]/,""))}const s={tweet_outer:"div.css-1dbjc4n.r-1adg3ll.r-1ny4l3l",tweet_content:".css-901oao.r-a023e6.r-16dba41.r-rjixqe.r-bcqeeo.r-bnwqim.r-qvutc0",user_name:".css-901oao.css-bfa6kz.r-1awozwy.r-6koalj.r-1tl8opc.r-a023e6.r-b88u0q.r-rjixqe.r-bcqeeo.r-1udh08x.r-3s2u2q.r-qvutc0",user_id:".css-901oao.css-bfa6kz.r-18u37iz.r-16dba41.r-bcqeeo.r-qvutc0",timeline:"main",checked_tweet_class_name:"spam-tweets-compressor-checked",media:Object.values({image:".css-1dbjc4n.r-1867qdf.r-1phboty.r-rs99b7.r-1s2bzr4.r-1ny4l3l.r-1udh08x.r-o7ynqc.r-6416eg",video:".css-1dbjc4n.r-1867qdf.r-1phboty.r-rs99b7.r-1s2bzr4.r-1ny4l3l.r-1udh08x",summary_card:".css-1dbjc4n.r-1867qdf.r-1phboty.r-rs99b7.r-18u37iz.r-1ny4l3l.r-1udh08x.r-o7ynqc.r-6416eg",summary_with_large_image:".css-1dbjc4n.r-1867qdf.r-1phboty.r-rs99b7.r-1ny4l3l.r-1udh08x.r-o7ynqc.r-6416eg"}).join(","),verified_badge:"svg.r-4qtqp9.r-yyyyoo.r-1xvli5t.r-9cviqr.r-f9ja8p.r-og9te1.r-bnwqim.r-1plcrui.r-lrvibr",hashtag_link_mention:".css-4rbku5.css-18t94o4.css-901oao.css-16my406.r-1loqt21.r-poiln3.r-bcqeeo.r-qvutc0",link_scheme_outer:".css-901oao.css-16my406.r-1tl8opc.r-hiw28u.r-qvk6io.r-bcqeeo.r-qvutc0",tweet_button_inner:".css-4rbku5.css-18t94o4.css-1dbjc4n.r-42olwf.r-sdzlij.r-1phboty.r-rs99b7.r-1waj6vr.r-1loqt21.r-19yznuf.r-64el8z.r-1ny4l3l.r-o7ynqc.r-6416eg.r-lrvibr",normal_text:".css-901oao.css-16my406.r-1tl8opc.r-bcqeeo.r-qvutc0",show_tweet_button:".show-tweet-button"},c=["d","g","i","m","s","u","y"],i=new RegExp(`^/(.*)/([${c.join("")}]*)$`);function a(e){return i.test(e)}function l(e){const t=function(e){if(!a(e))return{string:e,flag:null};const t=e.replace(i,"$1"),n=new Set(e.replace(i,"$2").split("")),r=Array.from(n).filter((e=>c.includes(e)));return{string:t,flag:r.length?r.join(""):null}}(e);return t.flag?new RegExp(t.string,t.flag):new RegExp(t.string)}function u(e,t){const n=a(t);if("string"==typeof e)return n?l(t).test(e):e.includes(t);{let r=!1;return e.forEach((e=>{(n&&l(t).test(e)||e===t)&&(r=!0)})),r}}function d(e,t){let s="and"===e[0];return e[1].forEach((c=>{let i=!1;if(null!==(l=c)&&"object"==typeof l&&"mode"in l&&"type"in l&&"string"in l&&"string"==typeof l.mode&&"string"==typeof l.type&&"string"==typeof l.string){let e=!1;switch(c.type){case"text":e=u(t.content,c.string);break;case"hashtag":e=u(t.hashtag,r(c.string));break;case"id":e=u(t.user_id,o(c.string));break;case"name":e=u(t.user_name,c.string);break;case"link":e=u(t.link,a(c.string)?c.string:n(c.string))}i="include"===c.mode?e:!e}else i=d(c,t);var l;"and"!==e[0]||i?"or"===e[0]&&i&&(s=!0):s=!1})),s}function _(e,t){for(const n of t)if(n){if(a(n)&&l(n).test(e))return!0;if(e.includes(n))return!0}return!1}function g(e,n,r){const o=_(t(e.content),n.ng_word)||n.include_user_name&&_(t(e.user_name),n.ng_word)?browser.i18n.getMessage("compress_reason_ng_word"):!!d(r,e)&&browser.i18n.getMessage("compress_reason_advanced_detection_default"),c=Boolean(e.querySelector(s.verified_badge))&&!n.include_verified_account;return!1===o||c?[!1]:[!0,o]}const m={include_verified_account:!1,include_user_name:!1,show_reason:!0,decompress_on_hover:!1,ng_word:[""],allow_list:[""],exclude_url:["https://twitter.com/home"],advanced_filter:[""],main_color:"rgb(29, 161, 242)",background_color:"rgb(0, 0, 0)",font_color:"rgb(255, 255, 255)"};class h{constructor(){this.setting=m,this.callback=void 0}async load(){const e=await browser.storage.local.get("setting"),t=m;return e.setting&&Object.keys(e.setting).filter((e=>e in m)).forEach((n=>t[n]=e.setting[n])),browser.storage.onChanged.addListener((e=>{this.setting=e.setting.newValue,this.callback&&this.callback()})),new Proxy(t,{get:(e,t)=>this.setting[t],set:(e,t,n)=>(this.setting[t]=n,this.save(),!0)})}save(){browser.storage.local.set({setting:this.setting})}onChange(e){this.callback=e}}class w{constructor(e,t){this.tweet=e,this.content_element=e.querySelector(s.tweet_content),this.emoji_detector=t}get_text_content(e){const t=e.cloneNode(!0),n=document.createElement("div");return n.appendChild(t),n.querySelectorAll("img").forEach((e=>{const t=this.emoji_detector.get_from_url(e.src);t&&e.insertAdjacentText("afterend",t),e.remove()})),n.textContent}get content(){return this.content_element?this.get_text_content(this.content_element)||"":null}get user_name(){const e=this.tweet.querySelector(s.user_name);return e&&this.get_text_content(e)||""}get user_id(){const e=this.tweet.querySelector(s.user_id);return e?o(e.textContent||""):null}get language(){return this.get_language()}async get_language(){const e=this.content_element;let t=this.content||"";if(e){const n=e.cloneNode(!0),r=document.createElement("div");r.appendChild(n),r.querySelectorAll(s.hashtag_link_mention).forEach((e=>e.remove())),t=r.textContent||""}const n=await browser.i18n.detectLanguage(t);return n.isReliable?n.languages[0].language.replace(/-.*$/,""):this.content_element&&this.content_element.lang?this.content_element.lang:""}compress(e,t){const n=document.createElement("button");n.setAttribute("class",this.tweet.getAttribute("class")||""),n.classList.add(s.show_tweet_button.replace(/^\./,""));const r=this.tweet.user_name,o=this.tweet.user_id;if(e){const t=browser.i18n.getMessage("decompress_button_strict_with_reason",[r,`@${o}`,e]);n.textContent=t}else{const e=browser.i18n.getMessage("decompress_button_strict_without_reason",[r,`@${o}`]);n.textContent=e}n.addEventListener("click",(()=>{this.tweet.style.display="block",n.remove()})),t&&n.addEventListener("mouseover",(()=>{this.tweet.style.display="block",n.remove()})),this.tweet.style.display="none",this.tweet.insertAdjacentElement("afterend",n)}get hashtag(){return[...this.tweet.querySelectorAll(s.hashtag_link_mention)].filter((t=>t.textContent&&e.includes(t.textContent[0]))).map((e=>r(e.textContent||"")))}get link(){return[...this.tweet.querySelectorAll(s.hashtag_link_mention)].filter((function(e){return Boolean(e.querySelector(s.link_scheme_outer))})).map((function(e){return n((e.textContent||"").replace(/…$/,""))}))}}async function f(e=!0){const t=await(new h).load();let n=!0;const r=document.querySelector(s.tweet_button_inner);if(r){const e=getComputedStyle(r).backgroundColor;e&&(t.main_color=e)}else n=!1;const o=getComputedStyle(document.body).backgroundColor;o?t.background_color=o:n=!1;const c=document.querySelector(s.normal_text);if(c?t.font_color=getComputedStyle(c).color:n=!1,!n&&e)return new Promise(((e,t)=>{setInterval((()=>{f(!1).then((()=>e())).catch((e=>t(e)))}),1e3)}));if(!n)throw"Failed to get color setting."}function b(e,t){return e.replace(/^rgb\(/,"rgba(").replace(/\)$/,`, ${t})`)}async function y(){const e=await(new h).load(),t=document.createElement("style");t.textContent=`\n:root {\n    --main_color: ${e.main_color};\n    --background_color: ${e.background_color};\n    --high_emphasize_text_color: ${b(e.font_color,.87)};\n    --medium_emphasize_text_color: ${b(e.font_color,.6)};\n}\n    `,document.body.appendChild(t)}async function p(e){const t=await fetch(e);return await t.json()}async function v(e){const t=[],n=await p("https://cdn.statically.io/gh/Robot-Inventor/stc-filter/main/dist/advanced_filter.json"),r=Object.keys(n).filter((t=>e.includes(n[t].id))).map((e=>n[e].url));for(const e of r){const n=await p(e);t.push(n.rule)}return["or",[...t]]}const q=new class{constructor(){this.emoji_list=void 0}async init(){const e=await fetch(browser.runtime.getURL("dist/twitter-emoji-url-list/twitter-emoji-url-list.json"));this.emoji_list=await e.json()}get_from_url(e){if(this.emoji_list&&e in this.emoji_list)return this.emoji_list[e];if(void 0===this.emoji_list)throw"Emoji.init() must be called before Emoji.using get_from_url().";return null}};q.init().then((async()=>{const e=new h,t=await e.load();async function n(){r=await v(t.advanced_filter)}let r=await v(t.advanced_filter);setInterval((()=>{n()}),86400),e.onChange((()=>{(async()=>{await n(),document.querySelectorAll(s.show_tweet_button).forEach((e=>e.click())),document.querySelectorAll("."+s.checked_tweet_class_name).forEach((e=>e.classList.remove(s.checked_tweet_class_name)))})()}));const c=document.body,i=new MutationObserver((()=>{const e=document.querySelector(s.timeline);if(e){i.disconnect(),f().then(y).catch((e=>console.error(e)));const n=e;new MutationObserver((()=>{!function(e,t){if(e.exclude_url.includes(location.href))return;const n=[...document.querySelectorAll(`${s.tweet_outer}:not(.${s.checked_tweet_class_name})`)].map((function(e){e.classList.add(s.checked_tweet_class_name);const t=new w(e,q),n="stc_show_user_id_error=true";return["/notifications"].includes(location.pathname)||null===t.content||null!==t.user_id||document.cookie.includes(n)||(alert(browser.i18n.getMessage("error_message_user_id_bug")),document.cookie="stc_show_user_id_error=true;max-age=86400"),e.content=t.content||"",e.user_name=t.user_name,e.user_id=t.user_id||"",e.language=t.language,e.compress=(e,n)=>{t.compress(e,n)},e.hashtag=t.hashtag,e.link=t.link,e}));for(const r of n){if(e.allow_list.map(o).includes(r.user_id))continue;const n=g(r,e,t);n[0]&&(e.show_reason?r.compress(n[1],e.decompress_on_hover):r.compress(void 0,e.decompress_on_hover))}}(t,r)})).observe(n,{childList:!0,subtree:!0})}}));i.observe(c,{childList:!0,subtree:!0})})).catch((e=>console.error(e)))})();